language: php
os: linux
version: ~> 1.0
php:
  - 7.3
  - 7.4

cache:
  directories:
    - "$HOME/.composer/cache"

services:
  - mysql

env:
  global: ACLI_PRINT_COMMAND_OUTPUT=1
  # @see https://pantheon.io/blog/highest-lowest-testing-multiple-symfony-versions
  jobs:
    - 'HIGHEST_LOWEST="update"'
    - 'HIGHEST_LOWEST="update --prefer-lowest"'

jobs:
  # We have to explicitly add Windows jobs because Travis CI doesn't support PHP on Windows.
  include:
    - os: windows
      language: shell
      git:
        autocrlf: false
      before_install:
        - choco install php
        - sed -i 's/memory_limit = .*/memory_limit = 512M/' /c/tools/php74/php.ini
        - choco install composer
        # Refresh env to pick up new paths added by Choco installs.
        - cmd.exe //c "RefreshEnv.cmd"
        # Emulate RefreshEnv to pick up new bin paths in Git Bash (the native Travis CI shell).
        - eval $(powershell -NonInteractive -Command 'write("export PATH=`"" + ([Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [Environment]::GetEnvironmentVariable("PATH","User")).replace("\","/").replace("C:","/c").replace(";",":") + ":`$PATH`"")')
      # Coveralls results get polluted by Windows builds, disable reporting.
      after_success: skip
    - stage: "Build packages for CLI"
      if: tag IS present
      install: composer install --no-dev --optimize-autoloader && composer box-install
      script: composer box-compile
      deploy:
        provider: releases
        api_key:
          secure: pptV1SxWRifZyFFJFfF1Y2qQRxQ+vhBEMzcY7knfVUJyDUk+zpc++vR0KfutrH9ZBQhrpTJdN6GQZzDgKh5rvq/RW9V26YXoNoFdzNjHWUIXKHqyRqdABSsg3R/P5lMq1zgTyJ6s4utf2COUU42MglptKF9h+Hk/Ux7vnboouvm5s6DeRYL97rrjzErwoySRluTAnesF4YmATmBSONfQJi0qIig7inqi79Gq2LWg5qxWejXrPtjNSD7XxcDHZVbMjiXfVuSpdozt+TXfjflJt6xjNamp/bjcC10GrSgMkerCKIM0DrmbzSuMf/OlvGcm6cqEq/M/IPG+xflvzK+GfRswnIxCf/03UTvRo/VnCtoDhMlxnuqpmkXWKgqggIP+rgXJqrCy6DoAmNB3zLjrMdggd5NgDc9Z78md1UcJToqQpeSIcHeCLtLLbVl0729SdTdDduFrqBSRwJDDHbSDzfpLAxjGdPFUtLouqSghzbYjMI6zqDIZ8HsMmTVSRA9zoi1EZ6UNhn067ddY28MGEZN14PNx/8r/vJ0VrTER0PRbDejK/ORPX2yPktkFIpPL/tHZ3Kw+pEdY9g9Ff0BYm+3uhRkQbW0TSAu3vEhZp7hnvRWMI6Pz50AOCa5tYjDR4bo/6mOqNmKYetA/6EVUvWiGdTYA1OHWTypXXF4g6qE=
        file: build/acli.phar
        skip_cleanup: true
        on:
          tags: true

before_install:
  - composer selfupdate

install:
  # Load composer dependencies.
  - composer validate --no-check-all --ansi
  - 'composer -n ${HIGHEST_LOWEST-install} --prefer-dist -o'

script:
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then export PHPUNIT_EXCLUDE_GROUP=skipWindows; fi
  - composer test

after_success:
  - ./vendor/bin/php-coveralls -vvv
